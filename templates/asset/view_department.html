<title>Các phòng ban</title>
{% extends "base.html" %}
{% load widget_tweaks %}
{% load humanize %}

{% block content %}
{% load static %}
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<style>
html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-image: url('/static/media/pexels-eberhard-grossgasteiger-2310713.jpg/');
            background-size: cover;
            background-repeat: repeat;
            width: 100%;
        }
.avatar {
    max-width: 50px;
    max-height: 35px;
    width: 50px;
    height: 35px;
    border-radius: 10%; 
}
#search-bar {
    width: 500px;
    padding: 8px;
    margin:  auto;
    border: 1px solid #ccc;
    border-radius: 4px;
}

/* Style the search button */
#search-button {
    padding: 8px;
    margin: 10px;
    border: 1px solid #007BFF;
    background-color: #007BFF;
    color: white;
    border-radius: 4px;
    cursor: pointer;
}
.search-container {
    position:relative;
    display:flex;
    margin-bottom: 30px;
}
input[type="checkbox"] {
    transform: scale(2.0);
}
a.active_assets{
    text-decoration: none;
    color: darkgreen;
}
a.broken_assets{
    text-decoration: none;
    color: red;
}
a.all_assets{
    text-decoration: none;
    color:black;
}
.wide-column {
    width: 25%;
}
.column1{
    width: 10%;
}
.column2{
    width: 15%; 
}
.column3{
    width: 10%; 
}
.column4{
    width: 25%; 
}
.column5 {
    width: 20%; 
}
.card-container{
        max-width: 900px;
        margin-left: 50px;
        display: flex;
    }
.column{
    width: 5%;
}
/* Phong cách mặc định cho màn hình có kích thước lớn */
.card1 {
    flex: 0 0 150%;
    margin-left: -50%;
    width: 600px;
    max-width:  600px; /* Ví dụ đặt giới hạn tối đa cho chiều rộng */
    max-height: 600px;
}

.card-container-2 .card {
    flex: 0 0 auto;
    margin-left: 0px;
}

/* Phong cách cho màn hình nhỏ hơn 768px */
@media (max-width: 768px) {
    .card, .card-container-2 .card {
        flex: 0 0 100%;
    }

    .card1 {
        flex: 0 0 100%; /* Đảm bảo thừa hưởng thiết lập flex từ .card */
        margin-left: 0; /* Loại bỏ lệch margin */
        width: 100%; /* Đặt chiều rộng phù hợp */
        max-width: 100%; /* Đảm bảo không vượt qua container */
    }

    /* Căn chỉnh lại container chứa biểu đồ cho màn hình nhỏ */
    .card-container, .card-container-2 {
        flex-direction: column;
        align-items: center;
    }
}
@media (max-width: 768px) {
        .col {
            width: 100%;
            max-width: 100%;
        }
        .p-5 {
            padding: 20px !important; /* Giảm padding */
        }
    }
#loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
.dropdown-item:hover {
        background-color: #080a91;
        color: #ffffff; /* Màu nền bạn muốn thay đổi khi di chuột qua */
    }
.dropdown-item.delete-item:hover {
        background-color: #ffffff; /* Màu nền khi di chuột qua */
        color: #ffffff; /* Màu chữ khi di chuột qua */
    }
</style>
<div id="loading-screen">
        <div class="spinner"></div>
    </div>
    <div id="content" style="display:none;">
<center>
    <div class="search-container">
    <input class="form-control" id="myInput" type="text" placeholder="Tìm kiếm" style="width: 1020px; height: 40px;"><button class="btn btn-primary">Tìm kiếm</button>
    </div>
</center>

<div id="search-results"></div>
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-dark">
                <tr>
                    <th class='column' scope = "col"><center>STT</center></th>
                    <th class="wide-column" scope = "col"><center>Tên phòng ban</center></th>
                    <th class="column1" scope = "col"><center>Số lượng tài sản</center></th>
                    <th class="column2" scope = "col"><center>Số lượng hỏng / Sử dụng được</center></th>
                    <th class="column3" scope = "col"><center>Số lượng trường</center></th>
                    <th class="column4" scope = "col"><center>Trạng thái<br>
                        (Ngưng/Đàm phán/Liên kết)</center></th>
                    <th class="column5" scope = "col"><center>Số lượng phòng lab</center></th>
                </tr>
            </thead>
        <tbody>
            {% for department in departments %}
                <tr>
                <td>{{ forloop.counter }}</td>
                <td>{% if department.name == 'Ban lãnh đạo' %}
                    <b><a href="{% url 'department_detail' department.id %}"><center>{{ department.name }}</center></a></b>
                    {% else %}
                    <b><a href="{% url 'department_detail_2' department.id %}"><center>{{ department.name }}</center></a></b>
                    {% endif %}</td>
                <td><center>{{department.asset_count}}</center></td>
                <td><center>{{department.asset_broken_count}} / {{department.asset_active_count}}</center></td>
                {% if 'Phòng mầm non' in department.name or 'Phòng tiểu học' in department.name%}
                <td><center>{{department.school_count}}</center></td>
                <td><center>{{department.stopped_school_count}} / {{department.negotiating_school_count}} / {{department.linking_school_count}}</center></td>
                {% else %}
                <td><center>-</center></td>
                <td><center>-</center></td>
                {% endif %}
                {% if 'Phòng mầm non' in department.name or 'Phòng tiểu học' in department.name%}
                <td><center>{{department.labroom_count}}</center></td>
                {% else %}
                <td><center>-</center></td>
                {% endif %}
                </tr>
            {% endfor %}
            </tbody>
        </table>

{% if request.user.is_superuser %}
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createDepartmentModal">
    Tạo Phòng Ban Mới
</button>
</div>
<!-- Modal -->
<div class="modal fade" id="createDepartmentModal" tabindex="-1" role="dialog" aria-labelledby="createDepartmentModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
    <div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title" id="createDepartmentModalLabel">Tạo Phòng Ban Mới</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
        </button>
    </div>
    <div class="modal-body">
        <form method="post" action="{% url 'create_department_2' %}">
        {% csrf_token %}
        <div class="form-group">
            <label for="{{ form.name.id_for_label }}">Tên phòng ban</label>
            <input type="text" class="form-control" id="TenPhongBan" name="name" required>
        </div>
        <button type="submit" class="btn btn-primary">Tạo Phòng Ban</button>
        </form>
    </div>
    </div>
</div>

{% endif %}
        </div>
    </div>
</div>


<br>
<center><div>
    <div class="row">
        <div class="col-sm-12 col-md-4">
            <a href="#" class="active_assets">
            <div class="p-5 mb-4 bg-light rounded-4">
                <div class="container-fluid py-10">
                    <h3 class="display-10 fw-bold">Tổng số lượng trường<br></h3><br><h4>{{total_school_count}}</h4>
                </div>
            </div>
            </a>
        </div>
        <div class="col-sm-12 col-md-4">
            <a href="#" class="broken_assets">
                <div class="p-5 mb-4 bg-light rounded-4">
                    <div class="container-fluid py-10">
                        <h3 class="display-10 fw-bold">Tổng số lượng phòng lab</h3><br><h4>{{total_labroom_count}}</h4>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-sm-12 col-md-4">
            <a href="{% url 'all_asset' %}" class="all_assets">
            <div class="p-5 mb-4 bg-light rounded-4">
                <div class="container-fluid py-10">
                    <h3 class="display-10 fw-bold">Tổng số lượng tài sản</h3><br><h4>{{total_asset_count }}</h4>
                </div>
            </div>
            </a>
    </div>
    </div>
</div></center>
</div>
<center>
    <div class="card-container" style="display: flex; justify-content: center;">
        <div class="card-container-2" style="display: flex; justify-content: left;">
            <!-- Biểu đồ thứ nhất -->
            <div class="card1" style="flex: 0 0 125%; margin-left: 0px;">
                <figure class="highcharts-figure" data-percentage-active="{{ all_percentages_active }}" data-percentage-broken="{{ all_percentages_broken }}">
                    <div id="container"></div>
                    
                </figure>
            </div>
        </div>
            <!-- Biểu đồ thứ hai -->
            
            <div class="card1" style="flex: 0 0 70%; margin-left: 00px;">
                <figure class="highcharts-figure-2" data-linking-percentage="{{ linking_percentage }}" data-negotiating-percentage="{{ negotiating_percentage }}" data-stopped-percentage="{{ stopped_percentage }}">
                    <div id="container-2"></div>
                    
                </figure>
            </div>
        </div>
</center>
</div>
</div>
</div>
</div>
<script>
    $(document).ready(function () {
        $("#myInput").on("input", filterDropdown);
    });

    function filterDropdown() {
        var value = $(this).val().toLowerCase();
        $(".table tbody tr").each(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
    }
    function goBack() {
        window.history.back();
    }
    function searchFunction() {
        // Add your search logic here
        alert("Search button clicked!");
    }
    document.addEventListener('DOMContentLoaded', function () {
        // Khởi tạo biểu đồ thứ nhất
        var figureElement1 = document.querySelector('.highcharts-figure');
        var percentageActive = parseFloat(figureElement1.getAttribute('data-percentage-active')) || 0;
        var percentageBroken = parseFloat(figureElement1.getAttribute('data-percentage-broken')) || 0;
    
        Highcharts.chart('container', {
            chart: {
                type: 'pie'
            },
            title: {
                text: 'Tỉ lệ tài sản'
            },
            tooltip: {
                valueSuffix: '%'
            },
            subtitle: {
                text:
                'Biểu đồ hiển thị tỉ lệ tất cả tài sản'
            },
            plotOptions: {
                series: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: [{
                        enabled: true,
                        distance: 20
                    }, {
                        enabled: true,
                        distance: -40,
                        format: '{point.percentage:.1f}%',
                        style: {
                            fontSize: '1.2em',
                            textOutline: 'none',
                            opacity: 0.7
                        },
                        filter: {
                            operator: '>',
                            property: 'percentage',
                            value: 10
                        }
                    }]
                }
            },
            series: [
                {
                    name: 'Percentage',
                    colorByPoint: true,
                    data: [
                        {
                            name: 'Tài sản hỏng',
                            y: percentageBroken
                        },
                        {
                            name: 'Tài sản sử dụng được',
                            sliced: true,
                            selected: true,
                            y: percentageActive,
                        },
                    ]
                }
            ]
        });
    });

    var chart2Initialized = false;

    if (!chart2Initialized) {
        var figureElement2 = document.querySelector('.highcharts-figure-2');
        var percentageLinking = parseFloat(figureElement2.getAttribute('data-linking-percentage')) || 0;
        var percentageNegotiating = parseFloat(figureElement2.getAttribute('data-negotiating-percentage')) || 0;
        var percentageStopped = parseFloat(figureElement2.getAttribute('data-stopped-percentage')) || 0;

        Highcharts.chart('container-2', {
            chart: {
                type: 'pie'
            },
            title: {
                text: 'Tỉ lệ các trường'
            },
            tooltip: {
                valueSuffix: '%'
            },
            subtitle: {
                text: 'Biểu đồ hiển thị tỉ lệ các trường'
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        distance: 20,
                        format: '{point.percentage:.1f}%',
                        style: {
                            fontSize: '1.2em',
                            textOutline: 'none',
                            opacity: 0.7
                        },
                        filter: {
                            operator: '>',
                            property: 'percentage',
                            value: 10
                        }
                    }
                }
            },
            series: [
            {
                name: 'Percentage',
                colorByPoint: true,
                data: [
                {
                    name: 'Ngưng liên kết',
                    y: percentageStopped,
                    color: 'red',
                }, 
                {
                    name: 'Đang liên kết',
                    sliced: true,
                    selected: true,
                    y: percentageLinking,
                }, 
                {
                    name: 'Đang đàm phán',
                    sliced: true,
                    selected: true,
                    y: percentageNegotiating,
                    color: 'gold',
                },
                ]
            }
            ]
        });

        // Đánh dấu biến cờ đã được thiết lập để tránh thực thi lại
        chart2Initialized = true;
    }

document.addEventListener("DOMContentLoaded", function() {
            var loadingScreen = document.getElementById("loading-screen");
            var content = document.getElementById("content");

            function checkLoadingProgress() {
                var totalResources = document.images.length;
                var loadedResources = 0;

                for (var i = 0; i < totalResources; i++) {
                    if (document.images[i].complete) {
                        loadedResources++;
                    }
                }

                var loadPercentage = (loadedResources / totalResources) * 100;

                if (loadPercentage >= 95) {
                    loadingScreen.style.display = "none";
                    content.style.display = "block";

                    // Khi loading screen ẩn, cho phép cuộn trang
                    document.body.style.overflow = "auto";
                    document.documentElement.style.overflow = "auto";
                } else {
                    window.requestAnimationFrame(checkLoadingProgress);
                }
            }

            checkLoadingProgress();
        });

</script>
{% endblock %}